name: .NET CI - QLTV

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    name: Build & Test (.NET 8)

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x   # bạn đang dùng .NET 8

    # BƯỚC QUAN TRỌNG: Fix lỗi net8.0-windows (99% dự án QLTV VN đều dính cái này)
    - name: Fix Windows-specific target frameworks
      run: |
        find . -type f -name "*.csproj" -exec sed -i 's/net8.0-windows/net8.0/g' {} \;
        find . -type f -name "*.csproj" -exec sed -i 's/net7.0-windows/net7.0/g' {} \;
        find . -type f -name "*.csproj" -exec sed -i 's/net6.0-windows/net6.0/g' {} \;

    - name: Restore dependencies
      run: dotnet restore

    - name: Build solution
      run: dotnet build --no-restore --configuration Release

    - name: Run tests (dùng SQLite in-memory hoặc file tạm → không cần SQL Server thật)
      run: dotnet test --no-build --configuration Release --verbosity normal
      env:
        # RẤT QUAN TRỌNG: Đừng dùng connection string Windows nữa!
        # Dùng SQLite tạm hoặc InMemory để test chạy được trên Linux
        ConnectionStrings__DefaultConnection: "Data Source=QLTV_Test.db;Mode=ReadWrite;Cache=Shared"

    # (Tùy chọn) Code coverage – để sau khi CI xanh rồi bật cũng được
    # - name: Generate code coverage
    #   run: |
    #     dotnet test --no-build --configuration Release \
    #       --collect:"XPlat Code Coverage" \
    #       --settings .github/coverage.runsettings

    - name: Publish Web Application
      if: success()
      run: dotnet publish QLTV.Web/QLTV.Web.csproj --configuration Release --output ./publish
      # Đường dẫn chính xác đến project Web của bạn (thường là QLTV.Web/QLTV.Web.csproj)

    - name: Upload published artifact
      uses: actions/upload-artifact@v4
      with:
        name: QLTV-WebApp
        path: ./publish
        retention-days: 7
