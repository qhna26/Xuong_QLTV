name: .NET CI - QLTV

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    name: Build & Test (.NET 8)

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Cần nếu bạn dùng git history trong test

    - name: Setup .NET SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: 8.0.x   # Đổi thành 6.0.x / 7.0.x / 9.0.x nếu bạn dùng phiên bản khác

    - name: Restore dependencies
      run: dotnet restore

    - name: Build solution
      run: dotnet build --no-restore --configuration Release

    - name: Run tests
      run: dotnet test --no-build --configuration Release --verbosity normal
      env:
        # Nếu test của bạn cần connection string đặc biệt (ví dụ dùng InMemory hoặc SQLite)
        ConnectionStrings__DefaultConnection: "Data Source=DESKTOP-G2GFTFM;Initial Catalog=PRO_QuanLyThuVien;Integrated Security=True;Encrypt=True;Trust Server Certificate=True"

    # Tùy chọn: Tạo báo cáo coverage (rất đẹp khi gắn badge)
    - name: Generate code coverage
      run: |
        dotnet test --no-build --configuration Release \
          --collect:"XPlat Code Coverage" \
          --settings .github/coverage.runsettings

    - name: Upload coverage to Codecov (tuỳ chọn)
      uses: codecov/codecov-action@v4
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./coverage.cobertura.xml
        fail_ci_if_error: true

    # Tùy chọn: Publish artifact để download file build
    - name: Publish application
      if: success()
      run: dotnet publish "QLTV.Web.csproj" --configuration Release --output ./publish
      # Thay "QLTV.Web.csproj" bằng tên project startup chính của bạn

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: QLTV-published-app
        path: ./publish
        retention-days: 7
